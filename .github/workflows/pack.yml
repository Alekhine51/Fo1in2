name: Pack

on:
 push:
  paths:
  - '.github/workflows/pack.yml'

jobs:

 # https://fodev.net/pastebin/?u=fo1in2-release-list

 Test:
  runs-on: windows-latest
  env:
   MOD_DIR:            "Fallout2/Fallout1in2/"
   MOD_VERSION_STRING: "FALLOUT ET TU"
   MOD_VERSION_MAJOR:  0
   MOD_ZIP:            "Fallout1in2-v"
  steps:

  - name: Clone
    uses: actions/checkout@master
#   with:
#    fetch-depth: 1

  - name:  Environment
    run:   |
           :
           commits="$(git rev-list HEAD --count)"
           echo ::set-env name=MOD_VERSION_STRING::${MOD_VERSION_STRING} ${MOD_VERSION_MAJOR}.${commits}
           echo ::set-env name=MOD_ZIP::${MOD_ZIP}${MOD_VERSION_MAJOR}.${commits}.zip
    shell: bash

  - name:  Update ddraw.ini
    run:   |
           :
           ddraw_ini="$MOD_DIR/ddraw.ini"
           sed -i "s!^[\t\ ]*VersionString[\t\ ]*=[\t\ ]*.+!VersionString=$MOD_VERSION_STRING!" "$ddraw_ini"
           grep "^VersionString=" "$ddraw_ini"
           git diff "$ddraw_ini" | cat -v
    shell: bash

  - name:  Cleanup
    run:   |
           :
           rm -fR $MOD_DIR/Mapper/
           rm -f  $MOD_DIR/ddraw.dev.*
           rm -f  $MOD_DIR/ddraw.fo1in2.ini
           find Fallout2 -name '.gitignore' -delete
           find Fallout2 -name '.gitattributes' -delete
    shell: bash

  - name:  Copy UndatUI
    run:   |
           :
           cp "Tools/Undat UI/undat.exe" $MOD_DIR
           cp "Tools/Undat UI/undat_files.txt" $MOD_DIR
    shell: bash

  - name:  Pack
    run:   7z a "$MOD_ZIP" Fallout2 Readme.md
    shell: bash

  - name:  Pack listing
    run:   7z l "$MOD_ZIP"
    shell: bash
