name: Schedule

on:
 push:
  paths:
  - '.github/workflows/schedule.yml'
 schedule:
 - cron: 0 4 * * *

jobs:

 Maintenance:
  runs-on: windows-latest
  env:
   MOD_DIR:            "Fallout2/Fallout1in2"
   MOD_VERSION_STRING: "FALLOUT ET TU"
   MOD_VERSION_MAJOR:  0
  steps:

  - name: Clone
    uses: actions/checkout@master
    with:
     token: ${{ secrets.ANTALASKAYA_TOKEN }}
#    fetch-depth: 1

  - name:  ReAttach HEAD
    run:   git checkout $(echo "$GITHUB_REF" | awk -F / '{print $3}')
    shell: bash

  - name:  sfall-dev
    run:   |
           :
           SFALL_COMMIT=$(curl -Ls https://ci.appveyor.com/api/projects/rotators/sfall/branch/develop 2>/dev/null | jq -r '.build.commitId')
           curl -L "https://ci.appveyor.com/api/projects/rotators/sfall/artifacts/ddraw.dll?job=Configuration:%20ReleaseXP&branch=develop&pr=false" -o $MOD_DIR/ddraw.dev.dll
           SFALL_VERSION=$(powershell -command "(Get-Item $MOD_DIR/ddraw.dev.dll).VersionInfo.ProductVersion")
           echo "sfall v${SFALL_VERSION} (${SFALL_COMMIT})"
           git diff --quiet || (git add --update && echo "- sfall-dev (v${SFALL_VERSION}, phobos2077/sfall@${SFALL_COMMIT})" >> $HOME/gha.commit)
    shell: bash

  - name:  ReDefine
    run:   |
           :
           Tools/ReDefine/ReDefine.exe --config Tools/ReDefine/ReDefine.cfg --scripts $MOD_DIR/Mapper/source/scripts/ --headers $MOD_DIR/Mapper/source/scripts/headers/ >/dev/null
           grep "^Changed " ReDefine.log || true
           rm ReDefine*.log
           git diff --quiet || (git add --update && echo ::set-env name=GHA_REDEFINE::true)
    shell: bash

  - name:  Compile
    run:   |
           :
           ok=1
           .github/workflows/scripts.compile.sh --bytecode --optimization=1 || ok=0
           if [ $ok -eq 1 ]; then
              if [ "$GHA_REDEFINE" == "true" ]; then
                 echo "- ReDefine run" >> $HOME/gha.commit
              fi
              git diff --quiet || (git add --update && echo "- Scripts compilation" >> $HOME/gha.commit)
           else
              if [ "$GHA_REDEFINE" == "true" ]; then
                 echo "[WARNING] ReDefine excluded"
                 git reset HEAD  $MOD_DIR/Mapper/source/scripts/
                 git checkout -- $MOD_DIR/Mapper/source/scripts/
              fi
              echo "[WARNING] Compile excluded"
              git checkout -- $MOD_DIR/mods/fo1_base/scripts
           fi
    shell: bash

  - name:  Check
    run:   |
           :
           echo ::group::git status
           git status 2>&1
           echo ::endgroup::

           if [ -f "$HOME/gha.commit" ]; then
              sed -i '1s!^!Progress every day\n!' $HOME/gha.commit
              dos2unix $HOME/gha.commit
              echo ::set-env name=GHA_COMMIT::true
              cat $HOME/gha.commit
           else
              echo ::set-env name=GHA_COMMIT::false
           fi
    shell: bash

  - name:  Update configuration
    if:    env.GHA_COMMIT == 'true'
    run:   |
           :
           set -euxo pipefail
           commits=$(git rev-list HEAD --count)
           commits=$((commits+1))
           sfall=$(powershell -command "(Get-Item $MOD_DIR/ddraw.dll).VersionInfo.ProductVersion")
           dos2unix $MOD_DIR/ddraw.ini
           sed -ri "s!^;v[0-9\.]+.*!;v$sfall!" $MOD_DIR/ddraw.ini
           sed -ri "s!^[\t\ ]*VersionString[\t\ ]*=[\t\ ]*.+!VersionString=$MOD_VERSION_STRING $MOD_VERSION_MAJOR.$commits!" $MOD_DIR/ddraw.ini
           grep "^;v" $MOD_DIR/ddraw.ini
           grep "^VersionString=" $MOD_DIR/ddraw.ini
           unix2dos $MOD_DIR/*.ini $MOD_DIR/*.cfg $MOD_DIR/config/*
           git diff --quiet || (git add --update && echo "- Update configuration" >> $HOME/gha.commit)
    shell: bash

  - name:  Push
    if:    env.GHA_COMMIT == 'true'
    run:   |
           :
           echo ::group::git commit
           dos2unix $HOME/gha.commit
           git config --global user.name  "${{ secrets.ANTALASKAYA_NAME }}"
           git config --global user.email "${{ secrets.ANTALASKAYA_EMAIL }}"
           git commit --all --file="$HOME/gha.commit" 2>&1
           echo ::endgroup::

           echo ::group::git log
           git log -p -n 1 2>&1
           echo ::endgroup::

           if [ "${{ github.event_name }}" == "schedule" ]; then
              echo ::group::git push
              git push 2>&1
              echo ::endgroup::
           else
              echo "[WARNING] Repository not updated : event<${{ github.event_name }}> not allowed to push"
           fi
    shell: bash
    continue-on-error: true
